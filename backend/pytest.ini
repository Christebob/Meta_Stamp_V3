# ==============================================================================
# META-STAMP V3 Backend - Pytest Configuration
# ==============================================================================
# This configuration file defines test discovery patterns, asyncio mode,
# coverage settings, output formatting, and test execution parameters for
# the backend testing infrastructure.
# ==============================================================================

[pytest]
# ------------------------------------------------------------------------------
# Test Discovery Configuration
# ------------------------------------------------------------------------------
# Defines where pytest looks for tests and what naming conventions to follow.
# All test files should be in the tests/ directory and follow the test_*.py
# naming pattern.
# ------------------------------------------------------------------------------
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# ------------------------------------------------------------------------------
# Asyncio Configuration
# ------------------------------------------------------------------------------
# Enable automatic detection and execution of async tests using pytest-asyncio.
# The 'auto' mode automatically applies asyncio markers to async test functions.
# The fixture loop scope is set to 'function' for proper cleanup between tests.
# ------------------------------------------------------------------------------
asyncio_mode = auto
asyncio_default_fixture_loop_scope = function

# ------------------------------------------------------------------------------
# Output and Reporting Configuration
# ------------------------------------------------------------------------------
# Command-line options applied to every pytest run:
# -v            : Verbose output showing individual test names
# --strict-markers : Fail on unknown markers to catch typos
# --tb=short    : Use short traceback format for cleaner output
# --cov=app     : Measure code coverage for the app/ directory
# --cov-report=term-missing : Show missing lines in terminal output
# --cov-report=html : Generate HTML coverage report in htmlcov/
# ------------------------------------------------------------------------------
addopts = -v --strict-markers --tb=short --cov=app --cov-report=term-missing --cov-report=html

# ------------------------------------------------------------------------------
# Test Markers
# ------------------------------------------------------------------------------
# Custom markers for categorizing and filtering tests during execution.
# Usage examples:
#   pytest -m unit          : Run only unit tests
#   pytest -m integration   : Run only integration tests
#   pytest -m "not slow"    : Skip slow tests
#   pytest -m asyncio       : Run only async tests
# ------------------------------------------------------------------------------
markers =
    unit: Unit tests - fast, isolated tests with mocked dependencies
    integration: Integration tests - require running services (MongoDB, Redis, S3)
    slow: Slow-running tests - excluded from quick CI runs
    asyncio: Async tests - tests using async/await patterns

# ------------------------------------------------------------------------------
# Warning Filters
# ------------------------------------------------------------------------------
# Configure how pytest handles warnings during test execution.
# Suppress deprecation warnings to keep output clean while still catching
# actual test failures and errors.
# ------------------------------------------------------------------------------
filterwarnings =
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning
    ignore::pytest.PytestUnraisableExceptionWarning

# ------------------------------------------------------------------------------
# Environment and Version Requirements
# ------------------------------------------------------------------------------
# Ensure tests are run with the correct Python version.
# META-STAMP V3 requires Python 3.11+.
# ------------------------------------------------------------------------------
minversion = 3.11

# ------------------------------------------------------------------------------
# Logging Configuration
# ------------------------------------------------------------------------------
# Configure logging during test execution for debugging purposes.
# Set to INFO level to capture important events without excessive verbosity.
# ------------------------------------------------------------------------------
log_cli = false
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(name)s: %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# ------------------------------------------------------------------------------
# Timeout Configuration
# ------------------------------------------------------------------------------
# Set default timeout for tests to prevent hanging tests in CI/CD.
# Individual tests can override this with @pytest.mark.timeout decorator.
# Note: Requires pytest-timeout plugin to be installed.
# ------------------------------------------------------------------------------
timeout = 300

# ------------------------------------------------------------------------------
# Additional Test Execution Settings
# ------------------------------------------------------------------------------
# Configure test collection and execution behavior.
# - norecursedirs: Directories to exclude from test discovery
# - testpaths already defined above
# ------------------------------------------------------------------------------
norecursedirs = .git .venv __pycache__ .pytest_cache htmlcov dist build

# ==============================================================================
# Coverage Configuration (pytest-cov)
# ==============================================================================
# Note: Additional coverage settings can be configured in .coveragerc or
# pyproject.toml [tool.coverage] section. The settings below are applied
# via addopts for basic coverage reporting.
#
# Coverage Goals:
# - Minimum coverage target: 80% (aspirational, not enforced at ini level)
# - Exclude patterns: tests/, conftest.py (configured in .coveragerc)
# - HTML report generated in: htmlcov/
# - Terminal report shows missing lines for quick identification
#
# To run tests without coverage (faster):
#   pytest --no-cov
#
# To run with specific coverage threshold check:
#   pytest --cov-fail-under=80
# ==============================================================================
